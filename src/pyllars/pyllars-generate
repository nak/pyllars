#!/usr/bin/env python
import os
import sys
from typing import List

from pyllars.cppparser.generation.base import Generator
from pyllars.cppparser.generation.base2 import Compiler, Linker
from pyllars.cppparser.parser.clang_filter import ClangFilter


def comp(module_name: str, sources: List[str], compile_options: List[str], linker_options: List[str]):
    os.makedirs("generated", exist_ok=True)
    for src_path in sources:
        nodes = ClangFilter.parse(src_path=src_path, flags=compile_options)
        compiler = Compiler(compiler_flags=compile_options,
                            debug=True,
                            optimization_level="-O0")
        linker = Linker(compiler_flags=compile_options, linker_options=linker_options)
        Generator.generate_code(nodes, src_path=src_path, module_name=module_name, output_dir="generated",
                                compiler=compiler, linker=linker)
    sys.exit(0)


if __name__ == "__main__":
    index = sys.argv.index("--") if "--" in sys.argv else -1
    linker_index = sys.argv.index("--lflags") if "--lflags" in sys.argv else -1
    module_name = sys.argv[1]
    sources = sys.argv[2:index]
    compile_options = sys.argv[index + 1:linker_index] + ["-I."]
    linker_options = sys.argv[linker_index + 1:] if linker_index != -1 else []
    comp(module_name, sources, compile_options, linker_options)

